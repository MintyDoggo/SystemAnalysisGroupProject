@page "/configureartifacts"
@using Microsoft.Extensions.Configuration
@inject IHttpClientFactory ClientFactory
@inject IConfiguration Configuration

<h3>Current #of RequiredArtifact:@RequiredArtifacts?.Count</h3>
@for (int i = 0; i < RequiredArtifacts?.Count; i++)
{
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8 offset-md-2">
                <Card>
                    <CardBody>
                        @RequiredArtifacts[i].Name
                    </CardBody>
                </Card>
            </div>
        </div>
    </div>
}


<hr />
<Button Color="Color.Success" Clicked="@OnCreateRequiredArtifactsButtonClicked">@CreateCloseButtonText</Button>
@if (CreateRequiredArtifact)
{
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8 offset-md-2">
                <Card>
                    <CardBody>
                        Name: <TextEdit @ref="RequiredArtifactNameTextEdit" Placeholder="ie. Collage Transcript" />
                    </CardBody>
                </Card>
            </div>
        </div>
    </div>
    <Button Color="Color.Success" Clicked="@OnSubmitButtonClicked">Submit</Button>
}



@code
{
    public List<RequiredArtifactModel> RequiredArtifacts { get; set; }
    public bool CreateRequiredArtifact = false;
    string CreateCloseButtonText = "Create Required Artifact";
    TextEdit RequiredArtifactNameTextEdit;

    // Blazor event
    protected override async Task OnInitializedAsync()
    {
        await Reload();
    }

    async Task Reload()
    {
        RequiredArtifacts = new List<RequiredArtifactModel>();
        // Update our RequiredArtifacts list
        try
        {
            // The API endpoint to call
            string endpoint = Configuration.GetValue<string>("MUSMDatabaseServicesAPI") + "GetRequiredArtifacts/";

            IEnumerable<RequiredArtifactModel> getRequiredArtifactsResponse = await ClientFactory.CreateClient().GetFromJsonAsync<IEnumerable<RequiredArtifactModel>>(endpoint);
            RequiredArtifacts.Clear();
            RequiredArtifacts.AddRange(getRequiredArtifactsResponse);
        }
        catch (Exception e)
        {
            Console.WriteLine("Database services must be offline");
        }



        // always call StateHasChanged!
        StateHasChanged();
    }

    void OnCreateRequiredArtifactsButtonClicked()
    {
        if (CreateRequiredArtifact)
        {
            CreateRequiredArtifact = false;
            CreateCloseButtonText = "Create Required Artifact";
        }
        else
        {
            CreateRequiredArtifact = true;
            CreateCloseButtonText = "Close";
        }
        StateHasChanged();
    }

    async Task OnSubmitButtonClicked()
    {
        try
        {
            //// The API endpoint to call
            //string endpoint = Configuration.GetValue<string>("MUSMDatabaseServicesAPI") + "CreateRequiredArtifactAndReturnId/";
            //
            //var result = await ClientFactory.CreateClient().PostAsJsonAsync(endpoint, new { Name = "gbh" }, new JsonSerializerOptions() { PropertyNameCaseInsensitive = true });

            RequiredArtifactModel requiredArtifactToSend = new RequiredArtifactModel { Id = 6, Name = "gfsdht" };
            // The API endpoint to call
            string endpoint = Configuration.GetValue<string>("MUSMDatabaseServicesAPI") + "CreateRequiredArtifactAndReturnId/";

            // The HTTP request body we will send
            string jsonRequiredArtifact = JsonSerializer.Serialize<RequiredArtifactModel>(requiredArtifactToSend);
            StringContent httpContent = new(jsonRequiredArtifact);

            // Call the endpoint
            HttpResponseMessage response = await ClientFactory.CreateClient().PostAsync(endpoint, httpContent);
        }
        catch (Exception e)
        {
            Console.WriteLine("Database services must be offline");
        }

        await Reload();
    }



}
